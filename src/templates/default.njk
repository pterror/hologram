{#- Entity Definitions -#}
{% block definitions %}
  {% if entities | length > 0 or others | length > 0 %}
    {#- Responding entities -#}
    {% for entity in entities %}
      {{- "\n\n" if not loop.first -}}
<defs for="{{ entity.name }}" id="{{ entity.id }}">
{{ entity.facts | join("\n") }}
</defs>
      {% if memories[entity.id] and memories[entity.id] | length > 0 %}

<memories for="{{ entity.name }}" id="{{ entity.id }}">
{{ memories[entity.id] | join("\n") }}
</memories>
      {% endif %}
    {% endfor %}

    {#- Referenced and User Entities -#}
    {% for entity in others %}
      {{- "\n\n" if entities | length > 0 or not loop.first -}}
<defs for="{{ entity.name }}" id="{{ entity.id }}">
{{ entity.facts | join("\n") }}
</defs>
    {% endfor %}

    {#- Multi-Entity Response Format -#}
    {% if entities | length > 1 %}
      {{- "\n" -}}
      {% if freeform -%}
        You are writing as: {{ entities | join(", ", "name") }}. They may interact naturally in your response. Not everyone needs to respond to every message - only include those who would naturally engage. If none would respond, reply with only: none
      {%- else %}
You are: {{ entities | join(", ", "name") }}. Format your response with name prefixes:
{{ entities[0].name }}: Hello there!
{{ entities[1].name }}: Nice to meet you.

Start each character's dialogue on a new line with their name followed by a colon. They may interact naturally.

Not everyone needs to respond to every message. Only respond as those who would naturally engage with what was said. If none would respond, reply with only: none
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock definitions %}

{#- Message history -#}
{% block history %}
  {{- "\n" -}}
  {% for msg in history %}
    {{- "\n" if not loop.first -}}
    {% call send_as("assistant" if responders[msg.entity_id] else "user") -%}
      {{ msg.author }}: {{ msg.content }}
    {%- endcall %}
  {% endfor %}
{% endblock history %}
